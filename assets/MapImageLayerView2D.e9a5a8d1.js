var E=Object.defineProperty,A=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var S=(r,e,t)=>e in r?E(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,c=(r,e)=>{for(var t in e||(e={}))V.call(e,t)&&S(r,t,e[t]);if(P)for(var t of P(e))F.call(e,t)&&S(r,t,e[t]);return r},q=(r,e)=>A(r,M(e));import{af as o,ag as m,d0 as G,ah as U,z as R,r as g,dS as L,cx as T,d7 as z,m as D,ds as N,I as O}from"./vendor.85f7dae5.js";import{t as Q}from"./BitmapContainer.97a33c73.js";import{f as H,u as W}from"./LayerView.96933026.js";import{r as j}from"./BaseGraphicContainer.b5f81ed2.js";import{n as k}from"./HighlightGraphicContainer.5ab30cb1.js";import{S as B}from"./ExportStrategy.5fd4bdb6.js";import{c as J}from"./ExportImageParameters.a446a74d.js";import{s as K,a as X}from"./drapedUtils.19e7f0bf.js";import{t as Y,d as Z}from"./popupUtils.6538ef30.js";import{i as ee}from"./RefreshableLayerView.f170071f.js";import"./WGLContainer.58232395.js";import"./enums.457e23f9.js";import"./pixelUtils.81a2c47a.js";import"./Container.710b0eab.js";import"./VertexArrayObject.37b5010e.js";import"./Texture.0a5e9578.js";import"./VertexElementDescriptor.0406f2d4.js";import"./enums.d6db9796.js";import"./Utils.c81af201.js";import"./ProgramTemplate.222695da.js";import"./StyleDefinition.3146490e.js";import"./config.bd364997.js";import"./GeometryUtils.5ea26345.js";import"./MaterialKey.d6d4c400.js";import"./earcut.91e104de.js";import"./CIMSymbolHelper.1288b346.js";import"./BidiEngine.b9926823.js";import"./GeometryUtils.e53da643.js";import"./projectionSupport.d4bcbcd3.js";import"./json.da51edc4.js";import"./FeatureContainer.e9c6d16b.js";import"./TileContainer.3466b105.js";import"./visualVariablesUtils.6c4193ad.js";import"./visualVariablesUtils.36e1778e.js";import"./Matcher.4fc35cf2.js";import"./tileUtils.847f5850.js";import"./TileClipper.9eab18a5.js";import"./Geometry.e891c191.js";import"./ExpandedCIM.5149f774.js";import"./quantizationUtils.bb304765.js";import"./devEnvironmentUtils.f51567b1.js";import"./schemaUtils.a6cfb8c2.js";import"./createSymbolSchema.86478aa4.js";import"./MD5.67d7a872.js";import"./util.94a60279.js";import"./ComputedAttributeStorage.fdd6354d.js";import"./vec3f32.8179e08f.js";import"./Bitmap.b76451b3.js";import"./sublayerUtils.8d976e24.js";const te=r=>{let e=class extends r{initialize(){this.exportImageParameters=new J({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,a){const{layer:h}=this;if(!t)return Promise.reject(new R("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:h}));const l=this.get("view.scale"),y=[],f=async i=>{const p=i.minScale===0||l<=i.minScale,s=i.maxScale===0||l>=i.maxScale;if(i.visible&&p&&s){if(i.sublayers)i.sublayers.forEach(f);else if(i.popupEnabled){const d=Z(i,q(c({},a),{defaultPopupTemplateEnabled:!1}));g(d)&&y.unshift({sublayer:i,popupTemplate:d})}}},_=h.sublayers.toArray().reverse().map(f);await Promise.all(_);const $=y.map(async({sublayer:i,popupTemplate:p})=>{await i.load().catch(()=>{});const s=i.createQuery(),d=g(a)?a.event:null,v=K({renderer:i.renderer,event:d}),w=this.createFetchPopupFeaturesQueryGeometry(t,v);if(s.geometry=w,s.outFields=await Y(i,p),this.layer.type==="map-image"&&"floors"in this.view){var x,I;const C=(x=this.view)==null||(I=x.floors)==null?void 0:I.clone(),u=L(C,i);g(u)&&(s.where=s.where?`(${s.where}) AND (${u})`:u)}const b=await this._loadArcadeModules(p);return b&&b.arcadeUtils.hasGeometryOperations(p)||(s.maxAllowableOffset=w.width/v),(await i.queryFeatures(s)).features});return(await T($)).reduce((i,p)=>p.value?[...i,...p.value]:i,[]).filter(i=>i!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(a=>a.type==="expression"))return z()}};return o([m()],e.prototype,"exportImageParameters",void 0),o([m({readOnly:!0})],e.prototype,"exportImageVersion",null),o([m()],e.prototype,"layer",void 0),o([m()],e.prototype,"suspended",void 0),o([m(G)],e.prototype,"timeExtent",void 0),e=o([U("esri.views.layers.MapImageLayerView")],e),e},re=D.getLogger("esri.views.2d.layers.MapImageLayerView2D");let n=class extends te(ee(H(W))){constructor(){super(...arguments),this._highlightGraphics=new N}update(r){this.strategy.update(r).catch(e=>{O(e)||re.error(e)})}attach(){const{imageMaxWidth:r,imageMaxHeight:e,version:t}=this.layer,a=t>=10.3,h=t>=10;this._bitmapContainer=new Q,this.container.addChild(this._bitmapContainer);const l=new j({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new k(this.view.featuresTilingScheme)});this.container.addChild(l.container),this.strategy=new B({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:r,imageMaxHeight:e,imageRotationSupported:a,imageNormalizationSupported:h,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(this.watch("view.floors",()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(r,e){return this._highlightGraphics.add(r),{remove:()=>{this._highlightGraphics.remove(r)}}}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}createFetchPopupFeaturesQueryGeometry(r,e){return X(r,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,a){return this.layer.fetchImage(r,e,t,c({timeExtent:this.timeExtent,floors:this.view.floors},a))}};o([m()],n.prototype,"strategy",void 0),o([m()],n.prototype,"updating",void 0),n=o([U("esri.views.2d.layers.MapImageLayerView2D")],n);const Ze=n;export{Ze as default};
