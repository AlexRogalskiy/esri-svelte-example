import{L as t,r as e,bI as r,jD as o,jx as n,bC as s,ao as a,eG as i,q as c}from"./vendor.d0a39f0f.js";import{a as u}from"./quat.8d7fb927.js";import{b as l,a as f,d as m,r as p,o as d,e as g,t as x,g as b,s as h,j as v,k as w,v as y,m as C,p as j,q as A,w as M}from"./DefaultMaterial_COLOR_GAMMA.0688382b.js";import{m as B,c as T,y as $,f as F}from"./meshFeatureSet.09a9eadb.js";import{T as S,i as q,c as E,x as L,u as O,L as R,O as I,E as V}from"./BufferView.0e91c841.js";import{a as D,f as G,h as N,r as k,c as z,n as _}from"./vec33.7050de41.js";import{b as K}from"./georeference.07d1c825.js";import"./types.738f7bc2.js";import"./Version.3475413a.js";import"./earcut.9760c2d2.js";import"./deduplicate.405f49bb.js";async function P(i,c,u){const d=new l(function(r){return null!=r&&r.resolveFile?{busy:!1,request:async(o,n,s)=>{const a=r.resolveFile(o),i="image"===n?"image":"binary"===n?"array-buffer":"json";return(await t(a,{responseType:i,signal:e(s)?s.signal:null})).data}}:null}(u)),g=(await f(d,c,u,!0)).model,x=g.lods.shift(),b=new Map,h=new Map;g.textures.forEach(((t,e)=>b.set(e,function(t){return new B({data:t.data,wrap:W(t.parameters.wrap)})}(t)))),g.materials.forEach(((t,e)=>h.set(e,function(t,e){const n=new s(function(t,e){return p(Y(t[0]),Y(t[1]),Y(t[2]),e)}(t.color,t.opacity)),i=t.emissiveFactor?new s((c=t.emissiveFactor,a(Y(c[0]),Y(c[1]),Y(c[2])))):null;var c;return new T({color:n,colorTexture:r(o(t.textureColor,(t=>e.get(t)))),normalTexture:r(o(t.textureNormal,(t=>e.get(t)))),emissiveColor:i,emissiveTexture:r(o(t.textureEmissive,(t=>e.get(t)))),occlusionTexture:r(o(t.textureOcclusion,(t=>e.get(t)))),alphaMode:J(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:r(o(t.textureMetallicRoughness,(t=>e.get(t))))})}(t,b))));const v=function(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1},o=new Map,s=new Map,a=[];for(const i of t.parts){const{attributes:{position:t,normal:c,color:u,tangent:l,texCoord0:f}}=i,m=`\n      ${Q(t,o)}/\n      ${Q(c,o)}/\n      ${Q(u,o)}/\n      ${Q(l,o)}/\n      ${Q(f,o)}/\n      ${U(i.transform)}\n    `;let p=!1;const d=n(s,m,(()=>(p=!0,{start:e,length:t.count})));p&&(e+=t.count),c&&(r.normal=!0),u&&(r.color=!0),l&&(r.tangent=!0),f&&(r.texCoord0=!0),a.push({gltf:i,writeVertices:p,region:d})}return{vertexAttributes:{position:m(S,e),normal:r.normal?m(q,e):null,tangent:r.tangent?m(E,e):null,color:r.color?m(L,e):null,texCoord0:r.texCoord0?m(O,e):null},parts:a,components:[]}}(x);for(const t of v.parts)H(v,t,h);const{position:w,normal:y,tangent:C,color:j,texCoord0:A}=v.vertexAttributes,M={position:w.typedBuffer,normal:e(y)?y.typedBuffer:null,tangent:e(C)?C.typedBuffer:null,uv:e(A)?A.typedBuffer:null,color:e(j)?j.typedBuffer:null},F=K(M,i,u);return{transform:F.transform,components:v.components,spatialReference:i.spatialReference,vertexAttributes:new $({position:F.vertexAttributes.position,normal:F.vertexAttributes.normal,tangent:F.vertexAttributes.tangent,color:M.color,uv:M.uv})}}function Q(t,e){if(c(t))return"-";const r=t.typedBuffer;return`${n(e,r.buffer,(()=>e.size))}/${r.byteOffset}/${r.byteLength}`}function U(t){return e(t)?t.toString():"-"}function H(t,r,o){r.writeVertices&&function(t,r){const{position:o,normal:n,tangent:s,color:a,texCoord0:c}=t.vertexAttributes,l=r.region.start,{attributes:f,transform:m}=r.gltf,p=f.position.count;if(D(o.slice(l,p),f.position,m),e(f.normal)&&e(n)){const t=i(u(),m);G(n.slice(l,p),f.normal,t)}else e(n)&&N(n,0,0,1,{dstIndex:l,count:p});if(e(f.tangent)&&e(s)){const t=i(u(),m);g(s.slice(l,p),f.tangent,t)}else e(s)&&x(s,0,0,1,1,{dstIndex:l,count:p});if(e(f.texCoord0)&&e(c)?b(c.slice(l,p),f.texCoord0):e(c)&&h(c,0,0,{dstIndex:l,count:p}),e(f.color)&&e(a)){const t=f.color,e=a.slice(l,p);if(4===t.elementCount)t instanceof E?v(e,t,255):t instanceof L?w(e,t):t instanceof R&&y(e,t,8);else{x(e,255,255,255,255);const r=I.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof q?k(r,t,255):t instanceof I?z(r,t):t instanceof V&&_(r,t,8)}}else e(a)&&x(a.slice(l,p),255,255,255,255)}(t,r);const n=r.gltf,s=function(t,e){switch(e){case 4:return A(t,M);case 5:return j(t);case 6:return C(t)}}(n.indices||n.attributes.position.count,n.primitiveType),a=r.region.start;if(a)for(let e=0;e<s.length;e++)s[e]+=a;t.components.push(new F({faces:s,material:o.get(n.material),trustSourceNormals:!0}))}function J(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function W(t){return{horizontal:X(t.s),vertical:X(t.t)}}function X(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function Y(t){return t**(1/d)*255}export{P as loadGLTFMesh};
